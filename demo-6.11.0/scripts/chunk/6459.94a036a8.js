"use strict";(self.webpackChunkamis_editor_demo=self.webpackChunkamis_editor_demo||[]).push([[6459],{56459:function(t,e,a){a.r(e),a.d(e,{ServiceRenderer:function(){return m},default:function(){return f},eventTypes:function(){return v}});var r=a(31635),o=a(96540),i=a(43346),n=a.n(i),s=a(88055),d=a.n(s),c=a(5917),h=a(25627),u=a(11331),p=a.n(u),l=a(50346),v=["inited","onApiFetched","onSchemaApiFetched","onWsFetched"],f=function(t){function e(e){var a=t.call(this,e)||this;return a.dataProviders=a.initDataProviders(e.dataProvider),a.handleQuery=a.handleQuery.bind(a),a.handleAction=a.handleAction.bind(a),a.handleChange=a.handleChange.bind(a),a.reload=a.reload.bind(a),a.silentReload=a.silentReload.bind(a),a.initInterval=a.initInterval.bind(a),a.afterDataFetch=a.afterDataFetch.bind(a),a.afterSchemaFetch=a.afterSchemaFetch.bind(a),a.runDataProvider=a.runDataProvider.bind(a),a.dataProviderSetData=a.dataProviderSetData.bind(a),a}return(0,r.__extends)(e,t),e.prototype.componentDidMount=function(){return(0,r.__awaiter)(this,void 0,void 0,function(){var t,e,a,o;return(0,r.__generator)(this,function(r){switch(r.label){case 0:return t=this.props,e=t.data,a=t.dispatchEvent,this.mounted=!0,[4,a("init",e,this)];case 1:return(null==(o=r.sent())?void 0:o.prevented)||this.initFetch(),[2]}})})},e.prototype.componentDidUpdate=function(t){var e,a=this,r=this.props,o=r.store,i=r.messages,n=i.fetchSuccess,s=i.fetchFailed;r.dataProvider!==t.dataProvider&&(this.dataProviders=this.initDataProviders(r.dataProvider),this.dataProviders&&(null===(e=this.dataProviders)||void 0===e?void 0:e.inited)&&this.runDataProvider("inited")),(0,c.B92)(t.api,r.api,t.data,r.data)&&(0,c.Amo)(r.api,o.data)&&o.fetchData(r.api,o.data,{successMessage:n,errorMessage:s}).then(function(t){a.runDataProvider("onApiFetched"),a.afterDataFetch(t)}),(0,c.B92)(t.schemaApi,r.schemaApi,t.data,r.data)&&(0,c.Amo)(r.schemaApi,o.data)&&o.fetchSchema(r.schemaApi,o.data,{successMessage:n,errorMessage:s}).then(function(t){a.runDataProvider("onSchemaApiFetched"),a.afterSchemaFetch(t)}),r.ws&&t.ws!==r.ws&&(this.socket&&this.socket.close(),this.socket=this.fetchWSData(r.ws,o.data)),(0,c.JQ)(t.defaultData,r.defaultData)&&o.reInitData(r.defaultData)},e.prototype.componentWillUnmount=function(){this.mounted=!1,this.runDataProviderUnsubscribe(),clearTimeout(this.timer),this.socket&&this.socket.close&&this.socket.close()},e.prototype.doAction=function(t,e,a,r){if(void 0===a&&(a=!1),"rebuild"===(null==t?void 0:t.actionType)){var o=this.props,i=o.schemaApi,n=o.store,s=o.dataProvider,d=o.messages,h=d.fetchSuccess,u=d.fetchFailed;n.updateData(r),clearTimeout(this.timer),(0,c.Amo)(i,n.data)&&n.fetchSchema(i,n.data,{successMessage:h,errorMessage:u}).then(this.afterSchemaFetch),s&&this.runDataProvider("inited")}},e.prototype.initFetch=function(){var t=this,e=this.props,a=e.schemaApi,r=e.initFetchSchema,o=e.api,i=e.ws,n=e.initFetch,s=e.initFetchOn,d=e.dataProvider,h=e.store,u=e.messages,p=u.fetchSuccess,l=u.fetchFailed;(0,c.Amo)(a,h.data,r)&&h.fetchSchema(a,h.data,{successMessage:p,errorMessage:l}).then(function(e){t.runDataProvider("onSchemaApiFetched"),t.afterSchemaFetch(e)}),(0,c.Amo)(o,h.data,n,s)&&h.fetchInitData(o,h.data,{successMessage:p,errorMessage:l}).then(function(e){t.runDataProvider("onApiFetched"),t.afterDataFetch(e)}),i&&(this.socket=this.fetchWSData(i,h.data)),d&&this.runDataProvider("inited")},e.prototype.initDataProviders=function(t){var e=this,a=p()(t)?d()(t):t,r={};if(a)if(p()(a))Object.keys(a).forEach(function(t){var o=e.normalizeProvider(a[t],t);r=n()(r,o||{})});else{var o=this.normalizeProvider(a,"inited");r=n()(r,o||{})}return r},e.prototype.normalizeProvider=function(t,e){var a,r;if(void 0===e&&(e="inited"),!~v.indexOf(e))return null;if("function"==typeof t)return(a={})[e]=t,a;if("string"==typeof t){var o=(0,c.uPQ)(t,"data","setData","env");return o?((r={})[e]=o,r):null}return null},e.prototype.runDataProvider=function(t){return(0,r.__awaiter)(this,void 0,void 0,function(){var e,a,o,i;return(0,r.__generator)(this,function(r){switch(r.label){case 0:return this.runDataProviderUnsubscribe(t),e=this.props.store,(a=this.dataProviders)&&~v.indexOf(t)&&(o=a[t])&&"function"==typeof o?[4,o(e.data,this.dataProviderSetData,this.props.env)]:[3,2];case 1:"function"==typeof(i=r.sent())&&(this.dataProviderUnsubscribe||(this.dataProviderUnsubscribe={}),this.dataProviderUnsubscribe[t]=i),r.label=2;case 2:return[2]}})})},e.prototype.runDataProviderUnsubscribe=function(t){var e,a=this.dataProviderUnsubscribe;if(a)if(t){var r=a[t];try{r&&"function"==typeof r&&r()}catch(t){console.error(t)}}else null===(e=Object.keys(a))||void 0===e||e.forEach(function(t){var e=a[t];try{e&&"function"==typeof e&&e()}catch(t){console.error(t)}})},e.prototype.dataProviderSetData=function(t){if(this.mounted){var e=this.props.store;e.updateData(t,void 0,!1),e.setHasRemoteData()}},e.prototype.fetchWSData=function(t,e){var a=this,r=this.props,o=r.env,i=r.store,n=(0,c.lSp)(t,e);o.wsFetcher(n,function(t){var e,r,s,d,c=t;if("status"in t&&"data"in t&&(c=t.data,0!==t.status))return i.updateMessage(null!==(r=null===(e=null==n?void 0:n.messages)||void 0===e?void 0:e.failed)&&void 0!==r?r:t.msg,!0),void o.notify("error",null!==(d=null===(s=null==n?void 0:n.messages)||void 0===s?void 0:s.failed)&&void 0!==d?d:t.msg);i.updateData(c,void 0,!1,n.concatDataFields),i.setHasRemoteData(),a.runDataProvider("onWsFetched"),a.afterDataFetch({ok:!0,data:c})},function(t){i.updateMessage(t,!0),o.notify("error",t)})},e.prototype.afterDataFetch=function(t){var e,a=(null==t?void 0:t.hasOwnProperty("ok"))?null!==(e=t.data)&&void 0!==e?e:{}:t,o=this.props,i=o.onBulkChange,n=o.dispatchEvent,s=o.store,d=o.formStore;(0,l.isAlive)(s)&&(null==n||n("fetchInited",(0,c.ed2)(this.props.data,(0,r.__assign)((0,r.__assign)({},a),{__response:{msg:s.msg,error:s.error},responseData:a,responseStatus:void 0===(null==t?void 0:t.status)?s.error?1:0:null==t?void 0:t.status,responseMsg:s.msg}))),!(0,c.Ime)(a)&&i&&d&&i(a,!1,{type:"api"}),(null==t?void 0:t.ok)&&this.initInterval(a))},e.prototype.afterSchemaFetch=function(t){var e=this.props,a=e.onBulkChange,o=e.formStore,i=e.dispatchEvent,n=e.store;null==i||i("fetchSchemaInited",(0,r.__assign)((0,r.__assign)({},t),{__response:{msg:n.msg,error:n.error},responseData:t,responseStatus:void 0===(null==t?void 0:t.status)?n.error?1:0:null==t?void 0:t.status,responseMsg:n.msg})),o&&(null==t?void 0:t.data)&&a&&a&&a(t.data),this.initInterval(t)},e.prototype.initInterval=function(t){var e=this.props,a=e.interval,r=e.silentPolling,o=e.stopAutoRefreshWhen,i=e.data;return clearTimeout(this.timer),a&&this.mounted&&(!o||!(0,c.pgu)(o,(0,c.ed2)(i,t)))&&(this.timer=setTimeout(r?this.silentReload:this.reload,Math.max(a,1e3))),t},e.prototype.reload=function(t,e,a,o,i){return(0,r.__awaiter)(this,void 0,void 0,function(){var t,a,n,s,d,h,u,p,l;return(0,r.__generator)(this,function(r){switch(r.label){case 0:return e?[2,this.receive(e,void 0,i)]:(t=this.props,a=t.schemaApi,t.initFetchSchema,n=t.api,t.initFetch,t.initFetchOn,s=t.store,d=t.dataProvider,h=t.messages,u=h.fetchSuccess,p=h.fetchFailed,clearTimeout(this.timer),(0,c.Amo)(a,s.data)?[4,s.fetchSchema(a,s.data,{successMessage:u,errorMessage:p})]:[3,3]);case 1:return l=r.sent(),[4,this.runDataProvider("onApiFetched")];case 2:r.sent(),this.afterSchemaFetch(l),r.label=3;case 3:return(0,c.Amo)(n,s.data)?[4,s.fetchData(n,s.data,{silent:o,successMessage:u,errorMessage:p})]:[3,6];case 4:return l=r.sent(),[4,this.runDataProvider("onSchemaApiFetched")];case 5:r.sent(),this.afterDataFetch(l),r.label=6;case 6:return d?[4,this.runDataProvider("inited")]:[3,8];case 7:r.sent(),r.label=8;case 8:return[2,s.data]}})})},e.prototype.silentReload=function(t,e){this.reload(t,e,void 0,!0)},e.prototype.receive=function(t,e,a){return(0,r.__awaiter)(this,void 0,void 0,function(){return(0,r.__generator)(this,function(e){return this.props.store.updateData(t,void 0,a),[2,this.reload()]})})},e.prototype.handleQuery=function(t){var e=this;return this.props.api||this.props.schemaApi?(!(null==t?void 0:t.hasOwnProperty("orderBy"))||![this.props.api,this.props.schemaApi].every(function(a){return!a||!(0,c.B92)(a,a,e.props.store.data,(0,c.ed2)(e.props.store.data,t))}))&&void this.receive(t):!!this.props.onQuery&&this.props.onQuery(t)},e.prototype.reloadTarget=function(t,e){},e.prototype.handleDialogConfirm=function(t,e,a,r){this.props.store.closeDialog(!0,t)},e.prototype.handleDialogClose=function(t){void 0===t&&(t=!1),this.props.store.closeDialog(t)},e.prototype.openFeedback=function(t,e){var a=this;return new Promise(function(r){var o=a.props.store;o.setCurrentAction({type:"button",actionType:"dialog",dialog:t},a.props.resolveDefinitions),o.openDialog(e,void 0,function(t){r(t)},a.context)})},e.prototype.handleAction=function(t,e,a,o,i){var n=this;void 0===o&&(o=!1);var s=this.props,d=s.onAction,h=s.store,u=s.env,p=s.api,l=s.translate;p&&"ajax"===e.actionType?(h.setCurrentAction(e,this.props.resolveDefinitions),h.saveRemote(e.api,a,{successMessage:l(e.messages&&e.messages.success),errorMessage:l(e.messages&&e.messages.failed)}).then(function(t){return(0,r.__awaiter)(n,void 0,void 0,function(){var a;return(0,r.__generator)(this,function(r){switch(r.label){case 0:return this.afterDataFetch(t),e.feedback&&(0,c.zNq)(e.feedback,h.data)?[4,this.openFeedback(e.feedback,h.data)]:[3,2];case 1:r.sent(),r.label=2;case 2:return(a=e.redirect&&(0,c.pbD)(e.redirect,h.data))&&u.jumpTo(a,e,h.data),e.reload&&this.reloadTarget((0,c.Wvn)(e.reload,h.data),h.data),[2]}})})}).catch(function(t){if(o||e.countDown)throw t})):d(t,e,a,o,i||this.context)},e.prototype.handleChange=function(t,e,a,r){var o,i,n=this.props,s=n.store,d=n.formStore,c=n.onChange;"string"==typeof e&&(null===(i=(o=s).changeValue)||void 0===i||i.call(o,e,t),d&&(null==c||c(t,e,a,r)))},e.prototype.renderBody=function(){var t=this.props,e=t.render,a=t.store,r=t.body;return t.classnames,e("body",a.schema||r,{key:a.schemaKey||"body",loading:a.loading,onQuery:this.handleQuery,onAction:this.handleAction,onChange:this.handleChange})},e.prototype.render=function(){var t=this.props,e=t.className,a=t.style,i=t.store,n=t.render,s=t.env,d=t.classPrefix,c=t.classnames,u=t.loadingConfig,p=t.showErrorMsg,l=t.testIdBuilder;return o.createElement("div",(0,r.__assign)({className:c("".concat(d,"Service"),e),style:a},null==l?void 0:l.getTestId()),!s.forceSilenceInsideError&&i.error&&!1!==p?o.createElement(h.pM,{level:"danger",showCloseButton:!0,onClose:function(){return i.updateMessage("")}},i.msg):null,this.renderBody(),o.createElement(h.y$,{size:"lg",overlay:!0,key:"info",show:i.loading,loadingConfig:u}),n("modal",(0,r.__assign)((0,r.__assign)({},i.action&&i.action.dialog),{type:"dialog"}),{key:"dialog",data:i.dialogData,onConfirm:this.handleDialogConfirm,onClose:this.handleDialogClose,show:i.dialogOpen}))},e.defaultProps={messages:{fetchFailed:"fetchFailed"},showErrorMsg:!0},e.propsList=[],(0,r.__decorate)([c.d6t,(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[]),(0,r.__metadata)("design:returntype",void 0)],e.prototype,"initFetch",null),(0,r.__decorate)([c.d6t,(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[Object]),(0,r.__metadata)("design:returntype",void 0)],e.prototype,"initDataProviders",null),(0,r.__decorate)([c.d6t,(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[Object,String]),(0,r.__metadata)("design:returntype",Object)],e.prototype,"normalizeProvider",null),(0,r.__decorate)([c.d6t,(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[Array,Object,Object,Array]),(0,r.__metadata)("design:returntype",void 0)],e.prototype,"handleDialogConfirm",null),(0,r.__decorate)([c.d6t,(0,r.__metadata)("design:type",Function),(0,r.__metadata)("design:paramtypes",[Object]),(0,r.__metadata)("design:returntype",void 0)],e.prototype,"handleDialogClose",null),e}(o.Component),m=function(t){function e(e,a){var r=t.call(this,e)||this;return a.registerComponent(r),r}return(0,r.__extends)(e,t),e.prototype.reload=function(e,a,o,i,n){return(0,r.__awaiter)(this,void 0,void 0,function(){var s;return(0,r.__generator)(this,function(r){return s=this.context,e?[2,s.reload(a?"".concat(e,"?").concat((0,c.Eqn)(a)):e,o)]:[2,t.prototype.reload.call(this,e,a,o,i,n)]})})},e.prototype.receive=function(e,a,o){return(0,r.__awaiter)(this,void 0,void 0,function(){var i;return(0,r.__generator)(this,function(r){return i=this.context,a?[2,i.send(a,e)]:[2,t.prototype.receive.call(this,e,a,o)]})})},e.prototype.componentWillUnmount=function(){t.prototype.componentWillUnmount.call(this),this.context.unRegisterComponent(this)},e.prototype.reloadTarget=function(t,e){this.context.reload(t,e)},e.prototype.setData=function(t,e){return this.props.store.updateData(t,void 0,e)},e.prototype.getData=function(){return this.props.store.data},e.contextType=c.MzX,(0,r.__decorate)([(0,c.A49)({type:"service",storeType:c.DtI.name,isolateScope:!0,storeExtendsData:function(t){return!t.formStore}}),(0,r.__metadata)("design:paramtypes",[Object,Object])],e)}(f)}}]);