"use strict";(self.webpackChunkamis_editor_demo=self.webpackChunkamis_editor_demo||[]).push([[5390],{46894:function(t,e){function a(t){return"object"!=typeof t||"toString"in t?t:Object.prototype.toString.call(t).slice(8,-1)}Object.defineProperty(e,"__esModule",{value:!0});var n="object"==typeof process&&!0;function r(t,e){if(!t){if(n)throw new Error("Invariant failed");throw new Error(e())}}e.invariant=r;var o=Object.prototype.hasOwnProperty,s=Array.prototype.splice,i=Object.prototype.toString;function c(t){return i.call(t).slice(8,-1)}var u=Object.assign||function(t,e){return l(e).forEach(function(a){o.call(e,a)&&(t[a]=e[a])}),t},l="function"==typeof Object.getOwnPropertySymbols?function(t){return Object.keys(t).concat(Object.getOwnPropertySymbols(t))}:function(t){return Object.keys(t)};function p(t){return Array.isArray(t)?u(t.constructor(t.length),t):"Map"===c(t)?new Map(t):"Set"===c(t)?new Set(t):t&&"object"==typeof t?u(Object.create(Object.getPrototypeOf(t)),t):t}var d=function(){function t(){this.commands=u({},f),this.update=this.update.bind(this),this.update.extend=this.extend=this.extend.bind(this),this.update.isEquals=function(t,e){return t===e},this.update.newContext=function(){return(new t).update}}return Object.defineProperty(t.prototype,"isEquals",{get:function(){return this.update.isEquals},set:function(t){this.update.isEquals=t},enumerable:!0,configurable:!0}),t.prototype.extend=function(t,e){this.commands[t]=e},t.prototype.update=function(t,e){var a=this,n="function"==typeof e?{$apply:e}:e;Array.isArray(t)&&Array.isArray(n)||r(!Array.isArray(n),function(){return"update(): You provided an invalid spec to update(). The spec may not contain an array except as the value of $set, $push, $unshift, $splice or any custom command allowing an array value."}),r("object"==typeof n&&null!==n,function(){return"update(): You provided an invalid spec to update(). The spec and every included key path must be plain objects containing one of the following commands: "+Object.keys(a.commands).join(", ")+"."});var s=t;return l(n).forEach(function(e){if(o.call(a.commands,e)){var r=t===s;s=a.commands[e](n[e],s,n,t),r&&a.isEquals(s,t)&&(s=t)}else{var i="Map"===c(t)?a.update(t.get(e),n[e]):a.update(t[e],n[e]),u="Map"===c(s)?s.get(e):s[e];a.isEquals(i,u)&&(void 0!==i||o.call(t,e))||(s===t&&(s=p(t)),"Map"===c(s)?s.set(e,i):s[e]=i)}}),s},t}();e.Context=d;var f={$push:function(t,e,a){return h(e,a,"$push"),t.length?e.concat(t):e},$unshift:function(t,e,a){return h(e,a,"$unshift"),t.length?t.concat(e):e},$splice:function(t,e,n,o){return function(t,e){r(Array.isArray(t),function(){return"Expected $splice target to be an array; got "+a(t)}),b(e.$splice)}(e,n),t.forEach(function(t){b(t),e===o&&t.length&&(e=p(o)),s.apply(e,t)}),e},$set:function(t,e,a){return function(t){r(1===Object.keys(t).length,function(){return"Cannot have more than one key in an object with $set"})}(a),t},$toggle:function(t,e){y(t,"$toggle");var a=t.length?p(e):e;return t.forEach(function(t){a[t]=!e[t]}),a},$unset:function(t,e,a,n){return y(t,"$unset"),t.forEach(function(t){Object.hasOwnProperty.call(e,t)&&(e===n&&(e=p(n)),delete e[t])}),e},$add:function(t,e,a,n){return g(e,"$add"),y(t,"$add"),"Map"===c(e)?t.forEach(function(t){var a=t[0],r=t[1];e===n&&e.get(a)!==r&&(e=p(n)),e.set(a,r)}):t.forEach(function(t){e!==n||e.has(t)||(e=p(n)),e.add(t)}),e},$remove:function(t,e,a,n){return g(e,"$remove"),y(t,"$remove"),t.forEach(function(t){e===n&&e.has(t)&&(e=p(n)),e.delete(t)}),e},$merge:function(t,e,n,o){var s,i;return s=e,r((i=t)&&"object"==typeof i,function(){return"update(): $merge expects a spec of type 'object'; got "+a(i)}),r(s&&"object"==typeof s,function(){return"update(): $merge expects a target of type 'object'; got "+a(s)}),l(t).forEach(function(a){t[a]!==e[a]&&(e===o&&(e=p(o)),e[a]=t[a])}),e},$apply:function(t,e){var n;return r("function"==typeof(n=t),function(){return"update(): expected spec of $apply to be a function; got "+a(n)+"."}),t(e)}},m=new d;function h(t,e,n){r(Array.isArray(t),function(){return"update(): expected target of "+a(n)+" to be an array; got "+a(t)+"."}),y(e[n],n)}function y(t,e){r(Array.isArray(t),function(){return"update(): expected spec of "+a(e)+" to be an array; got "+a(t)+". Did you forget to wrap your parameter in an array?"})}function b(t){r(Array.isArray(t),function(){return"update(): expected spec of $splice to be an array of arrays; got "+a(t)+". Did you forget to wrap your parameters in an array?"})}function g(t,e){var n=c(t);r("Map"===n||"Set"===n,function(){return"update(): "+a(e)+" expects a target of type Set or Map; got "+a(n)})}e.isEquals=m.update.isEquals,e.extend=m.extend,e.default=m.update,e.default.default=t.exports=u(e.default,e)},75390:function(t,e,a){a.r(e),a.d(e,{TaskRenderer:function(){return l},default:function(){return u}});var n=a(31635),r=a(96540),o=a(5917),s=a(46894),i=a.n(s),c=a(25627),u=function(t){function e(e){var a=t.call(this,e)||this;return a.state={items:e.items?e.items.concat():[]},a.handleLoaded=a.handleLoaded.bind(a),a.tick=a.tick.bind(a),a}return(0,n.__extends)(e,t),e.prototype.componentDidMount=function(){this.tick(!!this.props.checkApi)},e.prototype.componentDidUpdate=function(t){var e=this.props;t.items!==e.items?this.setState({items:e.items?e.items.concat():[]}):(0,o.B92)(t.checkApi,e.checkApi,t.data,e.data)&&this.tick(!0)},e.prototype.componentWillUnmount=function(){clearTimeout(this.timer)},e.prototype.reload=function(){this.tick(!0)},e.prototype.tick=function(t){var e=this;void 0===t&&(t=!1);var a=this.props,n=a.loadingStatusCode,r=a.data,s=a.interval,i=a.checkApi,c=a.env,u=this.state.items;if(clearTimeout(this.timer),t||u.some(function(t){return t.status===n}))return s&&!(0,o.Amo)(i)?c.alert("checkApi 没有设置, 不能及时获取任务状态"):void((0,o.Amo)(i,r)&&c&&c.fetcher(i,r).then(this.handleLoaded).catch(function(t){return e.setState({error:t})}))},e.prototype.handleLoaded=function(t){if(!Array.isArray(t.data))return this.props.env.alert("返回格式不正确, 期望 response.data 为数组, 包含每个 task 的状态信息");this.setState({items:t.data});var e=this.props.interval;clearTimeout(this.timer),this.timer=setTimeout(this.tick,e)},e.prototype.submitTask=function(t,e,a){var r=this;void 0===a&&(a=!1);var s=this.props,c=s.submitApi,u=s.reSubmitApi,l=s.loadingStatusCode,p=s.errorStatusCode,d=s.data,f=s.env;if(!a&&!(0,o.Amo)(c))return f.alert("submitApi 没有配置");if(a&&!(0,o.Amo)(u))return f.alert("reSubmitApi 没有配置");this.setState(i()(this.state,{items:{$splice:[[e,1,(0,n.__assign)((0,n.__assign)({},t),{status:l})]]}}));var m=a?u:c;(0,o.Amo)(m,d)&&f&&f.fetcher(m,(0,o.ed2)(d,t)).then(function(t){if(t&&t.data)if(Array.isArray(t.data))r.handleLoaded(t);else{m&&m.replaceData;var e=r.state.items.map(function(e){return e.key===t.data.key?(0,n.__assign)((0,n.__assign)({},m.replaceData?{}:e),t.data):e});r.handleLoaded((0,n.__assign)((0,n.__assign)({},t),{data:e}))}else clearTimeout(r.timer),r.timer=setTimeout(r.tick,4)}).catch(function(a){return r.setState(i()(r.state,{items:{$splice:[[e,1,(0,n.__assign)((0,n.__assign)({},t),{status:p,remark:a.message||a})]]}}))})},e.prototype.render=function(){var t=this,e=this.props,a=e.classnames,n=e.className,o=e.style,s=e.tableClassName,i=e.taskNameLabel,u=e.operationLabel,l=e.statusLabel,p=e.remarkLabel,d=e.btnText,f=e.retryBtnText,m=e.btnClassName,h=e.retryBtnClassName,y=e.statusLabelMap,b=e.statusTextMap,g=e.readyStatusCode,v=e.loadingStatusCode,k=e.canRetryStatusCode,E=e.translate,A=e.render,$=e.loadingConfig,C=this.state.items,_=this.state.error;return r.createElement("div",{className:a("Table-content",n),style:o},r.createElement("table",{className:a("Table-table",s)},r.createElement("thead",null,r.createElement("tr",null,r.createElement("th",null,i),r.createElement("th",null,E(u)),r.createElement("th",null,l),r.createElement("th",null,p))),r.createElement("tbody",null,_?r.createElement("tr",null,r.createElement("td",{colSpan:4},r.createElement("div",{className:"text-danger"},_))):C.map(function(e,n){return r.createElement("tr",{key:n},r.createElement("td",null,r.createElement("span",{className:a("word-break")},e.label)),r.createElement("td",null,e.status==v?r.createElement(c.y$,{loadingConfig:$,show:!0,icon:"reload",spinnerClassName:a("Task-spinner")}):e.status==k?r.createElement("a",{onClick:function(){return t.submitTask(e,n,!0)},className:a("Button","Button--danger","Button--size-md",h||m)},f||d):r.createElement("a",{onClick:function(){return t.submitTask(e,n)},className:a("Button","Button--default","Button--size-md",m,{disabled:e.status!==g})},d)),r.createElement("td",null,r.createElement("span",{className:a("label",y&&y[e.status||0])},b&&b[e.status||0])),r.createElement("td",null,e.remark?A("".concat(n,"/remark"),e.remark):null))}))))},e.defaultProps={className:"",tableClassName:"",taskNameLabel:"任务名称",operationLabel:"Table.operation",statusLabel:"状态",remarkLabel:"备注说明",btnText:"上线",retryBtnText:"重试",btnClassName:"",retryBtnClassName:"",statusLabelMap:["label-warning","label-info","label-info","label-danger","label-success","label-danger"],statusTextMap:["未开始","就绪","进行中","出错","已完成","出错"],initialStatusCode:0,readyStatusCode:1,loadingStatusCode:2,errorStatusCode:3,finishStatusCode:4,canRetryStatusCode:5,interval:3e3},e}(r.Component),l=function(t){function e(e,a){var n=t.call(this,e)||this;return a.registerComponent(n),n}return(0,n.__extends)(e,t),e.prototype.componentWillUnmount=function(){t.prototype.componentWillUnmount.call(this),this.context.unRegisterComponent(this)},e.contextType=o.MzX,(0,n.__decorate)([(0,o.A49)({type:"tasks"}),(0,n.__metadata)("design:paramtypes",[Object,Object])],e)}(u)}}]);